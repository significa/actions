name: Release Drafter

on:
  workflow_call:
    inputs:
      bump_type:
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create Release Draft
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag and calculate next version
        id: version
        uses: actions/github-script@v7
        with:
          script: |
            const bumpType = '${{ inputs.bump_type }}';
            
            // Get all tags
            const { data: tags } = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });
            
            // Find the latest semver tag
            const semverRegex = /^v?(\d+)\.(\d+)\.(\d+)$/;
            let latestVersion = { major: 0, minor: 0, patch: 0 };
            let latestTag = null;
            
            for (const tag of tags) {
              const match = tag.name.match(semverRegex);
              if (match) {
                const version = {
                  major: parseInt(match[1], 10),
                  minor: parseInt(match[2], 10),
                  patch: parseInt(match[3], 10),
                };
                
                // Compare versions
                if (
                  version.major > latestVersion.major ||
                  (version.major === latestVersion.major && version.minor > latestVersion.minor) ||
                  (version.major === latestVersion.major && version.minor === latestVersion.minor && version.patch > latestVersion.patch)
                ) {
                  latestVersion = version;
                  latestTag = tag.name;
                }
              }
            }
            
            console.log(`Latest tag: ${latestTag || 'none'}`);
            console.log(`Latest version: v${latestVersion.major}.${latestVersion.minor}.${latestVersion.patch}`);
            
            // Calculate next version based on bump type
            let nextVersion;
            switch (bumpType) {
              case 'major':
                nextVersion = `v${latestVersion.major + 1}.0.0`;
                break;
              case 'minor':
                nextVersion = `v${latestVersion.major}.${latestVersion.minor + 1}.0`;
                break;
              case 'patch':
              default:
                nextVersion = `v${latestVersion.major}.${latestVersion.minor}.${latestVersion.patch + 1}`;
                break;
            }
            
            console.log(`Next version: ${nextVersion}`);
            
            core.setOutput('next_version', nextVersion);
            core.setOutput('previous_tag', latestTag || '');

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.next_version }}" -m "Release ${{ steps.version.outputs.next_version }}"
          git push origin "${{ steps.version.outputs.next_version }}"

      - name: Create draft release with generated notes
        uses: actions/github-script@v8
        with:
          script: |
            const nextVersion = '${{ steps.version.outputs.next_version }}';
            const previousTag = '${{ steps.version.outputs.previous_tag }}';
            
            // Generate release notes using GitHub's API
            let releaseNotes = '';
            try {
              const notesResponse = await github.rest.repos.generateReleaseNotes({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: nextVersion,
                ...(previousTag && { previous_tag_name: previousTag }),
              });
              releaseNotes = notesResponse.data.body;
            } catch (error) {
              console.log('Could not generate release notes:', error.message);
              releaseNotes = `Release ${nextVersion}`;
            }
            
            // Create the draft release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: nextVersion,
              name: nextVersion,
              body: releaseNotes,
              draft: true,
              prerelease: false,
            });
            
            console.log(`Draft release created: ${release.html_url}`);
            core.summary.addRaw(`## Release Draft Created\n\n`);
            core.summary.addRaw(`**Version:** ${nextVersion}\n\n`);
            core.summary.addRaw(`**URL:** ${release.html_url}\n\n`);
            core.summary.addRaw(`### Release Notes\n\n${releaseNotes}`);
            await core.summary.write();
